# 微流控系统控制框架 Overview

## 系统目标

基于 ESP32 的闭环微流控控制系统。核心任务是精确控制微通道中的液体流量：通过流量传感器实时测量，PID 控制器计算误差，MP6 微泵执行驱动，形成完整的闭环控制回路。

## 系统框图

```
                    ┌─────────────────────────────────────────────┐
                    │              ESP32 主控                      │
                    │                                             │
  ┌──────────┐      │   ┌────────────┐    ┌──────────────┐        │      ┌──────────┐
  │ 上位机    │◄────►│   │ serial_comm│    │ sensor_config│        │      │  MP6     │
  │ (PC/App) │ UART │   │ (通信模块)  │    │ (系统配置)   │        │ GPIO │  微泵    │
  └──────────┘ WiFi │   └────────────┘    └──────────────┘        │◄────►│          │
                    │                                             │ PWM  └──────────┘
                    │   ┌────────────────────────────────────┐    │
                    │   │         控制回路 (Control Loop)      │    │
                    │   │                                    │    │
                    │   │  SLF3S 流量 ──► PID ──► MP6 驱动   │    │
                    │   │  (反馈)        (计算)   (输出)      │    │
                    │   └────────────────────────────────────┘    │
                    │                                             │
                    │   ┌──────────────────┐                      │
                    │   │   i2c_interface   │                      │
                    │   │   (I2C 硬件抽象)  │                      │
                    │   └────────┬─────────┘                      │
                    └────────────┼─────────────────────────────────┘
                                 │ I2C Bus (GPIO21=SDA, GPIO22=SCL)
                    ┌────────────┼──────────────────────┐
                    │            │                      │
              ┌─────┴─────┐ ┌───┴────────┐  ┌─────────┴──┐
              │ SLF3S     │ │ 压力传感器  │  │ 温度传感器  │
              │ 流量传感器 │ │ (0x76)     │  │ (0x48)     │
              │ (0x08)    │ │ [待实现]    │  │ [待实现]    │
              └───────────┘ └────────────┘  └────────────┘
```

## 闭环控制逻辑

```
设定流量(Setpoint) ──►(+)──► PID 控制器 ──► MP6 泵驱动信号
                       │ -                        │
                       │                          ▼
                       │                     微流控通道
                       │                          │
                       └──── SLF3S 流量测量 ◄──────┘
```

1. **设定值 (Setpoint)**：上位机通过串口/WiFi 下发目标流量 (µl/min)
2. **测量值 (Process Variable)**：SLF3S 流量传感器以 ~1kHz 的采样率实时测量当前流量
3. **PID 计算**：根据误差(设定值 - 测量值)计算控制输出
4. **执行机构**：MP6 微泵根据 PID 输出调整泵送频率/幅度

## 硬件组成

| 硬件 | 型号/说明 | 接口 | I2C 地址 | 状态 |
|------|----------|------|---------|------|
| 主控 | ESP32 | - | - | 已实现 |
| 流量传感器 | Sensirion SLF3S-0600F / 1300F | I2C | 0x08 | 已实现 |
| 微泵 | MP6 微型压电泵 | GPIO (Enable + Clock) | - | 待实现 |
| 压力传感器 | 待定 (预留 MS5837 类) | I2C | 0x76 | 待实现 |
| 温度传感器 | 待定 (预留 TMP117 类) | I2C | 0x48 | 待实现 |

## 默认引脚分配

| 功能 | GPIO | 说明 |
|------|------|------|
| I2C SDA | GPIO 21 | I2C 数据线，外接上拉电阻 |
| I2C SCL | GPIO 22 | I2C 时钟线，外接上拉电阻 |
| MP6 Enable | GPIO 14 | 微泵使能信号 |
| MP6 Clock | GPIO 27 | 微泵时钟/PWM 信号 |

所有引脚可通过 `idf.py menuconfig` → "Custom Configuration" → "Pin Configuration" 修改。

## 软件分层

```
┌──────────────────────────────────────┐
│          Application (main.c)        │  应用层：系统初始化、主控制循环
├──────────────────────────────────────┤
│   pid_controller  │  serial_comm     │  功能层：PID控制、通信协议
├──────────────────────────────────────┤
│ SLF3S_flow_sensor │   mp6_driver     │  驱动层：传感器/执行器驱动
├──────────────────────────────────────┤
│         i2c_interface                │  HAL层：I2C 硬件抽象
├──────────────────────────────────────┤
│     sensor_config (Kconfig)          │  配置层：引脚、传感器、通信配置
├──────────────────────────────────────┤
│         ESP-IDF / FreeRTOS           │  平台层：RTOS、驱动框架
└──────────────────────────────────────┘
```

## 配置系统 (Kconfig)

通过 `idf.py menuconfig` 进入 "Custom Configuration" 菜单，可配置：

- **传感器开关**：独立启用/禁用压力、温度、流量传感器
- **流量传感器型号**：SLF3S-0600F (0-600 µl/min, 高精度) 或 SLF3S-1300F (0-40 ml/min, 大流量)
- **泵驱动类型**：Low / High / Standard MP-Driver
- **通信方式**：Serial (UART) 或 WiFi
- **WiFi 参数**：SSID、密码、服务器地址和端口（仅 WiFi 模式下可见）

## 当前开发状态

- [x] I2C 硬件抽象层
- [x] SLF3S 流量传感器驱动（含自动检测型号）
- [x] Kconfig 配置系统
- [x] 系统配置模块
- [ ] MP6 微泵驱动
- [ ] PID 闭环控制器
- [ ] 串口/WiFi 通信模块
- [ ] 压力传感器驱动
- [ ] 温度传感器驱动
- [ ] FreeRTOS 多任务调度（传感器采集任务、控制任务、通信任务分离）
