# Microfluidic Control System

> **Firmware V3.0.0** | **Host PC GUI V1.0.0** | ESP32 + FreeRTOS | Python PyQt5

An ESP32-based closed-loop microfluidic control system that mimics blood circulation for organ-on-chip and lab-on-chip applications. The system drives a Bartels MP6 piezoelectric micropump, measures real-time liquid flow with a Sensirion SLF3S sensor, and closes the loop with a PID controller -- all at 10 Hz. A Python GUI on the host PC provides manual pump control, PID mode, live charting, data recording with CSV export, and hardware hot-plug detection.

```
                          UART 115200 8N1
  ┌───────────────────┐ ◄──────────────────► ┌───────────────────────────────┐
  │   Host PC (GUI)   │                      │          ESP32 MCU            │
  │  main_gui.py      │                      │                               │
  │  microfluidic_api  │                      │  serial_cmd_task (pri 5)      │
  └───────────────────┘                      │  sensor_read_task (pri 6)     │
                                             │         │            │        │
                                             │    GPIO │ PWM   I2C  │        │
                                             └─────┼───┼────────────┼────────┘
                                                   │   │            │
                                             ┌─────┘   │   ┌───────┘
                                             ▼         ▼   ▼
                                          ┌────────┐ ┌──────────┐
                                          │MCP4726 │ │  SLF3S   │
                                          │DAC 0x61│ │Flow 0x08 │
                                          └────────┘ └──────────┘
                                            MP6 Pump
                                         (Enable+Clock)
```

---

## Table of Contents

1. [System Components](#1-system-components)
2. [Key Documentation Links](#2-key-documentation-links)
3. [Project Structure](#3-project-structure)
4. [Wiring Diagram](#4-wiring-diagram)
5. [Experiment Pipeline](#5-experiment-pipeline)
6. [Building the GUI Executable](#6-building-the-gui-executable)
7. [Serial Protocol Summary](#7-serial-protocol-summary)
8. [Software Architecture](#8-software-architecture)
9. [Safety and Best Practices](#9-safety-and-best-practices)
10. [Troubleshooting](#10-troubleshooting)

---

## 1. System Components

### 1.1 Bartels MP6 Micropump

The [MP6](https://bartels-mikrotechnik.de/support-center/mp6-micropumps-series-datasheet/) is a MEMS piezoelectric diaphragm micropump with passive check valves. It requires a high-voltage AC signal generated by the Bartels MP-Driver board. The pump flow rate is controlled by varying the **amplitude** (drive voltage) and **frequency** of the AC signal.

| Parameter | Value | Source |
|-----------|-------|--------|
| Dimensions | 30 x 15 x 3.8 mm | [MP6 Datasheet](https://bartels-mikrotechnik.de/wp-content/uploads/2025/06/Datasheet-mp6-series.pdf) |
| Weight | 2 g | |
| Max flow rate (water) | 9 ml/min (9000 ul/min) | |
| Max flow rate (air) | 35 ml/min | |
| Max back pressure (water) | 450 mbar | |
| Max back pressure (air) | 140 mbar | |
| Burst pressure | 1.5 bar | |
| Power consumption | ~50 mW | |
| Internal volume | ~30 ul | |
| Operating temperature | 0 - 70 °C | |
| Lifetime | 5000 hours | |
| Self-priming | Yes | |
| Wetted material | PPSU (Polyphenylsulfone) | |
| IP rating | IP33 (modifiable to IP44) | |
| Electrical connector | 4-pin FCC 1.25 mm pitch (Molex) | |
| Fluidic connector | Barbed tube clip (OD 1.9 mm, length 3.5 mm) | |
| Recommended tubing | Tygon, 1.3 mm inner diameter | |
| Variants | mp6-hyb, mp6-liq, mp6-gas, mp6-gas+, mp6-pi, mp6-pp | |

### 1.2 Bartels Electronic Drivers

The Bartels electronic drivers convert low-voltage DC (3-5 V) into high-voltage AC (up to 250 Vpp) to drive the MP6 piezo element. **This project supports three driver variants**, selectable via `idf.py menuconfig`.

| Parameter | [mp-Driver](https://bartels-mikrotechnik.de/product/pump-driver/) (standard) | [mp-Highdriver](https://darwin-microfluidics.com/products/mp-highdriver-pump-driver) | [mp-Lowdriver](https://darwin-microfluidics.com/products/mp-lowdriver-controller) |
|-----------|--------------------------------------|------------------|-----------------|
| Dimensions | 10.5 x 20.5 x 5.2 mm | 10.16 x 25.4 x 4.9 mm | 10.16 x 25.4 x 5.2 mm |
| Supply voltage | 2.5 - 5.5 VDC | 2.7 - 5.5 VDC | 3 - 5.5 VDC |
| Current (at 5V) | avg. 30 mA | avg. 40 mA | avg. 40 mA |
| **Amplitude range** | **85 - 250 Vpp** | **10 - 250 Vpp** | **0 - 150 Vpp** |
| **Frequency range** | **25 - 226 Hz** | **50 - 800 Hz** | **8 - 2000 Hz** |
| Signal form | Rectangular only | Sine, rectangular, trapezoid | Sine, custom |
| Control interface | Enable + Clock + Analog Amplitude | I2C | I2C |
| Pin arrangement | DIL 14 | DIL 18 | DIL 18 |
| Thermal shutdown | 80 °C | 160 °C | -- |
| Max pumps | 1 (CH6) | 1 (CH5) | 1 (CH5) |
| Best for | Viscous fluids, higher flow | High flow, flexible waveforms | Low flow, fine amplitude control |

Source: [Electronic Driver Datasheet](https://bartels-mikrotechnik.de/wp-content/uploads/2025/03/datasheet-electronic-driver.pdf) and [driver comparison](https://blog.darwin-microfluidics.com/bartels-mp-multiboard2-and-comparison-of-the-mp-drivers/)

**Control interface (mp-Driver standard, used in this project):**
The standard mp-Driver accepts three signals from the ESP32:
- **Enable** (GPIO 14): HIGH = pump running, LOW = shutdown
- **Clock** (GPIO 27): PWM signal at 95% duty cycle, 25-226 Hz
- **Amplitude** (MCP4726 DAC output): analog voltage 0.35-1.30 V -> 85-250 Vpp

> **Note:** The firmware defines amplitude range 80-250 and frequency range 25-300 Hz as the software limits covering all three driver types. When using the standard mp-Driver, the effective frequency limit is 226 Hz and the minimum amplitude is ~85 Vpp. Values outside the driver's range are clamped by the hardware.

### 1.3 Sensirion SLF3S Flow Sensor

The [SLF3S](https://sensirion.com/products/catalog/SLF3S-0600F) is a liquid flow sensor based on Sensirion's CMOSens technology. It provides a linearized, temperature-compensated, fully calibrated digital output (I2C) with integrated air-in-line detection.

| Parameter | [SLF3S-0600F](https://sensirion.com/products/catalog/SLF3S-0600F) | [SLF3S-1300F](https://sensirion.com/products/catalog/SLF3S-1300F) |
|-----------|-------------|-------------|
| Nominal flow range | 0 - 2000 ul/min (2 ml/min) | 0 - 40 ml/min |
| Full scale output range | +/- 3250 ul/min | 0 - 40 ml/min |
| **Accuracy** | **+/- 5% of measured value or 0.5 ul/min** (whichever larger) | **+/- 5% of measured value or 0.05 ml/min** |
| Repeatability | +/- 0.5% of measured value or 0.5 ul/min | +/- 0.5% of measured value or 0.01 ml/min |
| Sensitivity | 0.5 ul/min | 0.05 ml/min |
| Response time | < 20 ms | < 20 ms |
| Scale factor (I2C) | 10 | 500 |
| I2C address | 0x08 | 0x08 |
| Supply voltage | 3.2 - 3.8 V (recommended 3.3 V) | 3.2 - 3.8 V |
| Dimensions | 48 x 15.5 x 8.9 mm | 48 x 15.5 x 8.9 mm |
| Max operating pressure | 12 bar | 12 bar |
| Fluidic connection | 1/4"-28 UNF female | 1/4"-28 UNF female |
| Wetted materials | PPS, stainless steel 316L, epoxy adhesive | PPS, stainless steel 316L, epoxy adhesive |
| Calibrated for | Water (cmd 0x08) and IPA (cmd 0x15) | Water and IPA |
| Operating temperature | 5 - 50 °C | 5 - 50 °C |
| Bidirectional | Yes | Yes |

Source: [SLF3S-0600F Datasheet](https://sensirion.com/media/documents/C4F8D965/66F56F53/LQ_DS_SLF3S-0600F_Datasheet.pdf), [SLF3S-1300F Datasheet](https://sensirion.com/media/documents/6971528D/63625D22/Sensirion_Datasheet_SLF3S-1300F.pdf)

**Signaling flags (9-byte read mode):**
- Bit 0 (`AIR_IN_LINE`): Air bubble detected in the flow path
- Bit 1 (`HIGH_FLOW`): Flow rate exceeds sensor measurement range
- Bit 5 (`EXP_SMOOTHING`): Exponential smoothing active

### 1.4 MCP4726 DAC

| Parameter | Value |
|-----------|-------|
| Resolution | 12-bit (4096 steps) |
| Interface | I2C (address 0x61) |
| Reference voltage | VDD (calibrated at 4.734 V) |
| Output range | 0 - 4.734 V |
| Purpose | Controls MP-Driver amplitude input |

Source: [MCP4726 Datasheet (Microchip)](https://www.microchip.com/en-us/product/mcp4726)

The DAC converts the digital amplitude setting (80-250) to an analog voltage (0.35-1.30 V) for the MP-Driver board.

**Amplitude mapping:**
```
amplitude 80  -> 0.35 V -> DAC code 287
amplitude 250 -> 1.30 V -> DAC code 1065

Formula: voltage = 0.35 + (amplitude - 80) * (1.30 - 0.35) / (250 - 80)
         DAC_code = voltage / 4.734 * 4096
```

### 1.5 ESP32 DevKit

| Parameter | Value |
|-----------|-------|
| Framework | ESP-IDF with FreeRTOS |
| I2C bus | GPIO 21 (SDA), GPIO 22 (SCL), 100 kHz |
| PWM output | GPIO 27 (MP-Driver clock, 95% duty) |
| Enable output | GPIO 14 (MP-Driver enable) |
| UART | UART0 (USB), 115200 baud, 8N1 |
| Configuration | `idf.py menuconfig` (Kconfig) |

Source: [ESP-IDF Programming Guide](https://docs.espressif.com/projects/esp-idf/en/latest/)

### 1.6 Bartels mp-bt Bubble Trap

The [mp-bt](https://bartels-mikrotechnik.de/product/mp-bt-bubble-trap/) uses a hydrophobic microporous membrane to remove air bubbles from the fluid stream. The membrane allows air to pass through while blocking liquid.

| Parameter | Value |
|-----------|-------|
| Dimensions | 17 x 19 x 10 mm |
| Internal volume | 100 ul |
| Materials | PPSU, PET |
| Fluidic ports | 1.9 mm OD (for 1.3 - 1.6 mm ID tubing) |
| Water entry pressure | 1.9 mbar |
| Required back pressure | 100 - 200 mbar |
| Air removal | Passive (hydrophobic microporous membrane) |
| Placement | Between MP6 pump outlet and flow sensor inlet |

Source: [mp-bt product page](https://darwin-microfluidics.com/products/mp-bt-bubble-trap-for-bartels-micropumps)

> **Note:** The bubble trap requires the MP6 pump to generate sufficient back pressure. During priming, run the pump at 250 Vpp / 300 Hz for effective air removal.

---

## 2. Key Documentation Links

### Bartels Mikrotechnik

| Resource | Description |
|----------|-------------|
| [Bartels Support Center](https://bartels-mikrotechnik.de/support-center/) | Technical support, FAQs, datasheets, manuals |
| [MP6 Micropump Series Datasheet (PDF)](https://bartels-mikrotechnik.de/wp-content/uploads/2025/06/Datasheet-mp6-series.pdf) | MP6 pump specifications, variants, and performance data |
| [Electronic Driver Datasheet (PDF)](https://bartels-mikrotechnik.de/wp-content/uploads/2025/03/datasheet-electronic-driver.pdf) | mp-Driver, mp-Highdriver, mp-Lowdriver, mp-Highdriver4 specs |
| [Pump Driver Product Page](https://bartels-mikrotechnik.de/product/pump-driver/) | Driver overview and ordering |
| [mp-bt Bubble Trap Product Page](https://bartels-mikrotechnik.de/product/mp-bt-bubble-trap/) | Bubble trap specifications |
| [Driver Comparison (Darwin)](https://blog.darwin-microfluidics.com/bartels-mp-multiboard2-and-comparison-of-the-mp-drivers/) | Side-by-side comparison of all driver boards |
| [Low Flow Rate Comparison (Darwin)](https://blog.darwin-microfluidics.com/bartels-mp-lowdriver-mp-highdriver-comparison-for-low-flow-rates/) | mp-Lowdriver vs mp-Highdriver for precision low flow |

### Sensirion

| Resource | Description |
|----------|-------------|
| [SLF3S-0600F Product Page](https://sensirion.com/products/catalog/SLF3S-0600F) | Sensor overview and ordering |
| [SLF3S-0600F Datasheet (PDF)](https://sensirion.com/media/documents/C4F8D965/66F56F53/LQ_DS_SLF3S-0600F_Datasheet.pdf) | Full specifications, I2C commands, performance curves |
| [SLF3S-1300F Datasheet (PDF)](https://sensirion.com/media/documents/6971528D/63625D22/Sensirion_Datasheet_SLF3S-1300F.pdf) | 1300F model specifications |
| [I2C Implementation Guide (PDF)](https://sensirion.com/media/documents/CBEB368E/61FAB1B9/LQ_AN_LiquidFlowSensors_ImplementationGuideToI2C_EN_D1.pdf) | I2C command reference, CRC, calibration |
| [SLF3x Engineering Guideline (PDF)](https://sensirion.com/media/documents/4AE082F4/659D456F/LQ_AN_EngineeringGuideline_SLF3x.pdf) | Handling, media compatibility, warm-up, best practices |
| [Sensirion Arduino I2C Driver (GitHub)](https://github.com/Sensirion/embedded-i2c-sf06-lf) | Reference I2C driver implementation |

### Espressif / MCP4726

| Resource | Description |
|----------|-------------|
| [ESP-IDF Programming Guide](https://docs.espressif.com/projects/esp-idf/en/latest/) | ESP32 development framework documentation |
| [MCP4726 Datasheet (Microchip)](https://www.microchip.com/en-us/product/mcp4726) | 12-bit DAC specifications |

---

## 3. Project Structure

```
SensorCDT_Microfluidic_Project/
├── README.md                          # This file - system tutorial and guide
├── API.md                             # Serial protocol specification (English)
│
├── Firmware/                          # ESP32 firmware (ESP-IDF project)
│   ├── CMakeLists.txt                 # Top-level CMake build file
│   ├── sdkconfig                      # ESP-IDF build configuration
│   │
│   └── main/                          # Firmware source code
│       ├── CMakeLists.txt             # Component CMake file
│       ├── Kconfig.projbuild          # Menuconfig definitions (sensors, pins, comm)
│       ├── main.c                     # FreeRTOS task creation, hardware init
│       ├── main.h                     # System state struct, global declarations
│       ├── serial_comm.c/.h           # UART command parsing, response/event sending
│       ├── mp6_driver.c/.h            # MP6 micropump driver (amplitude, frequency, enable)
│       ├── mcp4726_dac.c/.h           # MCP4726 DAC I2C driver (voltage output)
│       ├── MCP4726_DAC.md             # DAC component documentation
│       ├── SLF3S_flow_sensor.c/.h     # SLF3S flow sensor I2C driver
│       ├── pid_controller.c/.h        # PID controller (anti-windup, deviation detect)
│       ├── i2c_interface.c/.h         # I2C bus abstraction (init, probe, scan)
│       ├── sensor_config.c/.h         # Pin assignments, I2C addresses, sampling rates
│       └── sensor_config.h            # Compile-time config from Kconfig
│
└── HostPC/                            # Host PC software (Python)
    ├── README.md                      # GUI user guide (see HostPC/README.md)
    ├── requirements.txt               # Python dependencies (PyQt5, pyqtgraph, pyserial)
    ├── microfluidic_api.py            # Serial API wrapper (MicrofluidicController class)
    └── main_gui.py                    # PyQt5 GUI application
```

---

## 4. Wiring Diagram

### Electrical Connections

```
                        ESP32 DevKit
                     ┌────────────────┐
                     │                │
              SDA ───┤ GPIO 21        │
              SCL ───┤ GPIO 22        │
                     │                │    ┌──────────────────┐
           Enable ───┤ GPIO 14  ──────────►│ MP-Driver Board  │
           Clock  ───┤ GPIO 27  ──────────►│   (Enable, Clk)  │──── MP6 Pump
                     │                │    │   (Amplitude)     │
                     │          USB ──┼────│                   │
                     └────────────────┘    └───────┬──────────┘
                                                   │
                           I2C Bus (100 kHz)        │ Amplitude
                     ┌─────────┬───────────┐       │
                     │         │           │       │
                ┌────┴────┐ ┌──┴───┐  ┌────┴──────┴──┐
                │ SLF3S   │ │0x76  │  │   MCP4726     │
                │ Flow    │ │Press.│  │   DAC (0x61)  │
                │ (0x08)  │ │(TBD) │  │   Vout ───────┘
                └─────────┘ └──────┘  └───────────────┘

    NOTE: 4.7k pull-up resistors required on SDA and SCL lines.
```

### Fluidic Circuit

```
    ┌──────────┐     ┌──────────┐     ┌──────────────┐     ┌──────────┐     ┌──────────┐
    │          │     │  Bartels │     │   Bartels    │     │ Sensirion│     │Microfluid│
    │Reservoir ├────►│ MP6 Pump ├────►│ mp-bt Bubble ├────►│  SLF3S   ├────►│  Chip    │
    │          │     │          │     │    Trap      │     │Flow Sensor│    │          │
    └────▲─────┘     └──────────┘     └──────────────┘     └──────────┘     └────┬─────┘
         │                                                                       │
         └───────────────────────────────────────────────────────────────────────┘
                                    Return to reservoir

    Flow direction: Reservoir -> Pump -> Bubble Trap -> Flow Sensor -> Chip -> Reservoir
```

### Default Pin Assignment

| Function | GPIO | Notes |
|----------|------|-------|
| I2C SDA | 21 | External 4.7k pull-up to 3.3V |
| I2C SCL | 22 | External 4.7k pull-up to 3.3V |
| MP-Driver Enable | 14 | HIGH = pump running |
| MP-Driver Clock | 27 | PWM, 95% duty, 25-300 Hz |

All pins are configurable via `idf.py menuconfig` > "Custom Configuration" > "Pin Configuration".

---

## 5. Experiment Pipeline

This section walks through a complete experiment from hardware assembly to data collection.

### Step 1: Hardware Assembly

**Electrical wiring:**
1. Connect ESP32 GPIO 21 (SDA) and GPIO 22 (SCL) to the I2C bus with 4.7k pull-up resistors to 3.3V.
2. Connect MCP4726 DAC (0x61) and SLF3S flow sensor (0x08) to the I2C bus.
3. Connect GPIO 14 to MP-Driver Enable input.
4. Connect GPIO 27 to MP-Driver Clock input.
5. Connect MCP4726 analog output to MP-Driver Amplitude input.
6. Connect MP-Driver output to MP6 micropump.
7. Power the ESP32 via USB. Power the MP-Driver per its datasheet requirements.

**Fluidic tubing:**
1. Connect the reservoir outlet to the MP6 pump inlet.
2. Connect the MP6 pump outlet to the Bartels mp-bt bubble trap inlet.
3. Connect the bubble trap outlet to the SLF3S flow sensor inlet.
4. Connect the flow sensor outlet to the microfluidic chip inlet.
5. Connect the chip outlet back to the reservoir (closed loop).

### Step 2: Firmware Setup

**Prerequisites:** ESP-IDF v5.x installed and configured.

```bash
cd Firmware

# Configure the project (select sensor model, pins, communication method)
idf.py menuconfig
```

In `menuconfig`, navigate to **"Custom Configuration"**:

| Menu | Setting | Options |
|------|---------|---------|
| Sensor Configuration | Enable Flow Sensor | Yes (default) |
| Sensor Configuration | Flow Sensor Product Model | **SLF3S-0600F** (+/-3250 ul/min) or SLF3S-1300F (0-40 ml/min) |
| Sensor Configuration | Enable Pressure Sensor | Yes/No |
| Sensor Configuration | Enable Temperature Sensor | Yes/No |
| Pump Driver Type | Pump Driver | MP-Driver (default), Low MP-Driver, High MP-Driver |
| Communication Method | Communication | Serial (default) or WiFi |
| Pin Configuration | I2C SDA Pin | 21 (default) |
| Pin Configuration | I2C SCL Pin | 22 (default) |
| Pin Configuration | MP Driver Enable Pin | 14 (default) |
| Pin Configuration | MP Driver Clock Pin | 27 (default) |

```bash
# Build and flash
idf.py build
idf.py -p COMx flash monitor
```

The firmware will:
1. Initialize UART (always succeeds -- fatal only if this fails)
2. Initialize I2C bus
3. Scan I2C bus for devices
4. Probe and initialize detected hardware (non-fatal if devices are missing)
5. Create `serial_cmd_task` (priority 5) and `sensor_read_task` (priority 6)
6. Begin accepting commands immediately

### Step 3: Host PC Software Install

**Option A: Run from source (recommended for development)**

```bash
cd HostPC
pip install -r requirements.txt
python main_gui.py
```

Dependencies: `PyQt5>=5.15`, `pyqtgraph>=0.13`, `pyserial>=3.5`

**Option B: Run the standalone executable** (see [Section 6](#6-building-the-gui-executable))

### Step 4: First Connection

1. Plug the ESP32 into USB. Note the COM port (e.g., COM3 on Windows, /dev/ttyUSB0 on Linux).
2. Launch the GUI (`python main_gui.py`).
3. Select the COM port from the dropdown and click **Connect**.
4. The GUI will:
   - Open the serial port at 115200 baud
   - Flush stale boot data (300 ms delay)
   - Run an **I2C Scan** to detect hardware
   - Enable the data stream (`STREAM ON`)
5. Check the **Status Bar** for hardware detection:
   - **Driver: OK** -- MCP4726 DAC (0x61) detected (pump driver available)
   - **Flow Sensor: OK** -- SLF3S (0x08) detected
   - **Pressure: OK/N/A** -- Pressure sensor (0x76) status
6. If a device shows **N/A**, check wiring. The GUI re-scans every 5 seconds and will auto-detect when you plug in a device.

### Step 5: Priming and Bubble Removal (CRITICAL)

Priming removes air from the tubing and fills the fluidic circuit with liquid. **This step is essential** -- the MP6 pump must never run dry, and air bubbles corrupt flow readings.

1. Fill the reservoir with your working liquid (deionized water or IPA).
2. Set the calibration to match your liquid: **Tools > Calibration > Water** or **IPA**.
3. In **Manual Mode**, set:
   - **Amplitude: 250** (maximum drive voltage)
   - **Frequency: 300 Hz** (maximum drive frequency)
4. Click **PUMP ON**.
5. Run until:
   - Liquid flows visibly through all tubing
   - The bubble trap has captured visible air pockets
   - The flow rate reading on the chart stabilizes
   - No `AIR_IN_LINE` alerts appear (check the Alerts panel)
6. Reduce amplitude/frequency to your working range and continue.

**Tips:**
- Gently tap the tubing and bubble trap to dislodge stubborn bubbles.
- If `AIR_IN_LINE` alerts persist, there may be a leak in the tubing connections.
- The bubble trap passively removes air -- no user action required once liquid flows through it.

### Step 6: Manual Experiment

Once primed, run a manual (open-loop) experiment:

1. Select **Manual** mode in the Mode dropdown.
2. Adjust **Amplitude** (80-250) and **Frequency** (25-300 Hz) using the sliders.
   - Sliders update the firmware in real-time with 150 ms debounce.
3. Click **PUMP ON** to start. The GUI sends `AMP`, `FREQ`, then `PUMP ON` commands.
4. Observe the **Flow Rate** chart -- it updates at 10 Hz.
5. To record data, click **Record**. When finished, click **Stop** and then **Export CSV**.
6. Click **PUMP OFF** to stop the pump.

### Step 7: PID Closed-Loop Experiment

For precise flow control, use PID mode:

1. Select **PID** mode in the Mode dropdown.
2. Configure the PID parameters:
   - **Target**: desired flow rate in ul/min (e.g., 10.00)
   - **Duration**: experiment length in seconds (0 = run indefinitely)
   - **PID Gains**: Kp, Ki, Kd (defaults: 1.0, 0.1, 0.01)
3. Click **START PID**. A confirmation dialog appears.
4. Confirm to start. The firmware will:
   - Send `PID TUNE` to set gains
   - Send `PID START <target> <duration>` to begin closed-loop control
   - Auto-start the pump and begin adjusting amplitude every 100 ms
5. The **Flow Rate** chart shows a red dashed **target line** at your setpoint.
6. Watch the PID converge: the flow rate should approach and track the target.
7. The status bar shows **elapsed/duration** time.
8. PID stops automatically when the duration expires (`EVENT PID_DONE`), or click **STOP PID** to end early.
9. On completion, the pump stops and the system returns to MANUAL mode.

**PID details:**
- Output range: amplitude 80-250 (maps directly to `mp6_set_amplitude`)
- Anti-windup: integral clamped to +/-500
- Flow deviation alert: if flow deviates >20% from target for >10 seconds, `EVENT FLOW_ERR` is sent
- Frequency is fixed at its current value when PID starts; PID only adjusts amplitude

---

## 6. Building the GUI Executable

To create a standalone executable that doesn't require a Python installation:

```bash
cd HostPC
pip install pyinstaller
pyinstaller --onefile --windowed --name MicrofluidicGUI main_gui.py
```

The executable will be in `HostPC/dist/MicrofluidicGUI.exe`.

**Prerequisites for end users:**
- USB-to-serial driver for your ESP32 board:
  - **CP2102** (Silicon Labs): [driver download](https://www.silabs.com/developers/usb-to-uart-bridge-vcp-drivers)
  - **CH340** (WCH): [driver download](http://www.wch-ic.com/downloads/CH341SER_EXE.html)
- The driver must be installed before the GUI can detect the COM port.

**Running the executable:**
1. Double-click `MicrofluidicGUI.exe`.
2. Select the COM port and click Connect.
3. All features work identically to the Python source version.

---

## 7. Serial Protocol Summary

The ESP32 firmware communicates via UART0 at **115200 baud, 8N1, ASCII, newline-terminated**.

### PC -> ESP32 Commands

| Command | Format | Response | Notes |
|---------|--------|----------|-------|
| Pump ON | `PUMP ON` | `OK` | Manual mode only |
| Pump OFF | `PUMP OFF` | `OK` | Auto-stops PID if active |
| Set amplitude | `AMP <80-250>` | `OK` | Manual mode only |
| Set frequency | `FREQ <25-300>` | `OK` | Manual mode only (Hz) |
| PID start | `PID START <target> <duration>` | `OK` | Requires pump + sensor |
| PID stop | `PID STOP` | `OK` | Returns to MANUAL |
| PID target | `PID TARGET <value>` | `OK` | Update while running |
| PID tune | `PID TUNE <Kp> <Ki> <Kd>` | `OK` | Set gains |
| Status | `STATUS` | `S <fields...>` | 12-field status line |
| I2C scan | `SCAN` | `SCAN [addr...]` | Hex addresses |
| Stream ON/OFF | `STREAM ON` / `STREAM OFF` | `OK` | 10 Hz data toggle |
| Calibration | `CAL <WATER\|IPA>` | `OK` | Switch calibration liquid |

### ESP32 -> PC Async Events

| Message | Format | Trigger |
|---------|--------|---------|
| Data stream | `D <flow> <temperature>` | 10 Hz when stream is ON |
| PID done | `EVENT PID_DONE` | PID duration expired |
| Flow error | `EVENT FLOW_ERR <target> <actual>` | Sustained flow deviation (>20% for >10s) |
| Air in line | `EVENT AIR_IN_LINE` | Air bubble detected (edge-triggered) |
| High flow | `EVENT HIGH_FLOW` | Flow exceeds sensor range (edge-triggered) |

For the full protocol specification (STATUS field details, error codes, etc.), see [API.md](API.md).

---

## 8. Software Architecture

```
┌──────────────────────────────────────────────────────┐
│  Host PC: main_gui.py (PyQt5) + microfluidic_api.py │  GUI + API
├──────────────────────────────────────────────────────┤
│              UART Protocol (ASCII, \n)               │  Communication
├──────────────────────────────────────────────────────┤
│         Application Layer (main.c)                   │  FreeRTOS tasks,
│  serial_cmd_task (pri 5) | sensor_read_task (pri 6)  │  command dispatch
├──────────────────────────────────────────────────────┤
│  pid_controller        │  serial_comm                │  PID control,
│                        │                             │  protocol parsing
├──────────────────────────────────────────────────────┤
│  SLF3S_flow_sensor  │  mp6_driver  │  mcp4726_dac   │  Device drivers
├──────────────────────────────────────────────────────┤
│              i2c_interface                            │  I2C HAL
├──────────────────────────────────────────────────────┤
│          sensor_config (Kconfig)                     │  Pin & sensor config
├──────────────────────────────────────────────────────┤
│            ESP-IDF / FreeRTOS                        │  Platform
└──────────────────────────────────────────────────────┘
```

### FreeRTOS Tasks

| Task | Priority | Role |
|------|----------|------|
| `serial_cmd_task` | 5 | Blocks on UART, parses commands, dispatches to handlers |
| `sensor_read_task` | 6 (higher) | 10 Hz sensor sampling, PID compute, data stream, hot-plug re-probe (5s) |

Sensor task has higher priority to guarantee consistent 10 Hz sampling even when serial commands are processing. Both tasks share `g_state` via a FreeRTOS mutex. See `main.c` header comments for full RTOS architecture details.

### Closed-Loop Control

```
Setpoint (ul/min) ──►(+)──► PID Controller ──► Pump Amplitude (80-250)
                      │ -                              │
                      │                                ▼
                      │                         Microfluidic Channel
                      │                                │
                      └──── SLF3S Flow Sensor ◄────────┘
                              (10 Hz sampling)
```

- PID only adjusts amplitude; frequency is fixed when PID starts
- Anti-windup: integral clamped to +/-500, output clamped to 80-250

### Host PC Software

- **microfluidic_api.py** -- Thread-safe serial API with background listener and callbacks
- **main_gui.py** -- PyQt5 GUI (manual/PID control, real-time charts, data recording, alerts)

For detailed GUI documentation, see [HostPC/README.md](HostPC/README.md).

---

## 9. Safety and Best Practices

### Pump Safety (Bartels MP6)

Per the [MP6 Datasheet](https://bartels-mikrotechnik.de/wp-content/uploads/2025/06/Datasheet-mp6-series.pdf):

- **Never run the pump dry.** Always prime the system with liquid before starting the pump. Running dry can damage the piezo diaphragm and check valves.
- **Prime before every experiment.** See [Step 5: Priming and Bubble Removal](#step-5-priming-and-bubble-removal-critical).
- **Operating temperature: 0-70 °C.** Do not exceed this range.
- **Do not exceed burst pressure (1.5 bar).** Ensure no downstream blockages that could create excessive back pressure. Normal operating back pressure for water is < 450 mbar.
- **Use compatible liquids only.** The wetted material is PPSU (Polyphenylsulfone). Water and IPA are tested. Avoid aggressive solvents, strong acids/bases, or abrasive particles.
- **Maximum cable length: 1 m** between the driver board and the pump (per Bartels recommendation).
- **Lifetime: 5000 hours.** Track cumulative operating time for maintenance planning.
- **Amplitude/frequency limits depend on the driver board:**
  - mp-Driver (standard): 85-250 Vpp, 25-226 Hz
  - mp-Highdriver: 10-250 Vpp, 50-800 Hz
  - mp-Lowdriver: 0-150 Vpp, 8-2000 Hz (recommended < 800 Hz)

### Flow Sensor Safety (Sensirion SLF3S)

Per the [SLF3S Datasheet](https://sensirion.com/media/documents/C4F8D965/66F56F53/LQ_DS_SLF3S-0600F_Datasheet.pdf) and [Engineering Guideline](https://sensirion.com/media/documents/4AE082F4/659D456F/LQ_AN_EngineeringGuideline_SLF3x.pdf):

- **Power-up time: 25 ms** until the sensor responds to I2C. An additional **60 ms warm-up** (including 12 ms measurement initialization) is needed for reliable readings.
- **Supply voltage: 3.2-3.8 V** (recommended 3.3 V). Do not exceed 3.8 V.
- **Max operating pressure: 12 bar.** Do not exceed this or the sensor may be damaged.
- **Operating temperature: 5-50 °C.**
- **Avoid sustained air slugs.** Large air pockets cause erratic readings and trigger `AIR_IN_LINE`. Use the bubble trap to remove bubbles before the sensor.
- **Match calibration to your liquid.** Use `CAL WATER` (cmd byte 0x08) for water-based media or `CAL IPA` (cmd byte 0x15) for isopropanol. Mismatched calibration produces inaccurate flow readings.
- **Do not exceed sensor range.** The SLF3S-0600F nominal range is 0-2000 ul/min (full scale +/-3250 ul/min). Exceeding this triggers `HIGH_FLOW`.
- **Wetted materials: PPS, stainless steel 316L, epoxy adhesive.** Verify chemical compatibility with your fluid.
- **Response time: < 20 ms.** The 10 Hz firmware sampling (100 ms) is well within the sensor capability.

### Electrical Safety

- **4.7k pull-up resistors** on I2C SDA and SCL lines (to 3.3V). Without pull-ups, I2C communication will be unreliable. The I2C bus runs at 100 kHz.
- **Verify I2C addresses** with the SCAN command before running experiments. Expected: 0x08 (SLF3S), 0x61 (MCP4726).
- **Check DAC reference voltage.** The MCP4726 VDD is calibrated at 4.734V in firmware (`MCP4726_VDD` in `mcp4726_dac.h`). If your power supply differs, update this constant for correct amplitude mapping.
- **SLF3S sensor requires 3.3V supply** -- separate from the 5V DAC/driver supply. Do not connect the sensor to 5V.

### PID Tuning Tips

- Start with conservative gains: Kp=1.0, Ki=0.1, Kd=0.01.
- Increase Kp for faster response, but watch for oscillation.
- Increase Ki to eliminate steady-state error, but reduce it if you see overshoot.
- Kd helps dampen oscillation but amplifies noise -- use sparingly.
- Monitor the flow chart during tuning to observe convergence behavior.
- The PID output range is 80-250 (amplitude). If the target flow requires amplitude outside this range, PID cannot achieve it.

---

## 10. Troubleshooting

| Symptom | Possible Cause | Solution |
|---------|---------------|----------|
| GUI cannot find COM port | USB driver not installed | Install CP2102 or CH340 driver. Click **Refresh** in the GUI. |
| "Connection Error" on connect | Wrong COM port / port in use | Close other serial monitors. Verify the correct port in Device Manager. |
| I2C scan returns no devices | Wiring error / no pull-ups | Check SDA/SCL connections. Add 4.7k pull-up resistors to 3.3V. |
| Driver: N/A (pump not detected) | MCP4726 DAC not on I2C bus | Check DAC wiring to SDA/SCL. Verify power to DAC. Run I2C Scan. |
| Flow Sensor: N/A | SLF3S not on I2C bus | Check sensor wiring. Ensure sensor is powered. Run I2C Scan. |
| Flow reading is 0.00 | Pump not running / air in line | Start the pump. Prime the system. Check for `AIR_IN_LINE` alerts. |
| Flow reading is noisy/unstable | Air bubbles in tubing | Run priming at max amplitude/frequency. Tap tubing and bubble trap. |
| `AIR_IN_LINE` alert won't clear | Persistent air in flow path | Re-prime the system. Check for leaks in tubing connections. |
| `ERR PID_ACTIVE` | Manual command sent during PID | Stop PID first (`PID STOP` or click STOP PID), then use manual controls. |
| `ERR PUMP_UNAVAIL` / `ERR SENSOR_UNAVAIL` | Hardware not detected | Check I2C wiring. Hot-plug detection will auto-detect when reconnected. |
| PID oscillates / doesn't converge | PID gains too aggressive | Reduce Kp. Reduce Ki. Start with defaults (1.0, 0.1, 0.01). |
| `EVENT FLOW_ERR` during PID | Flow deviates >20% for >10s | Check for bubbles, leaks, or blockages. Verify target is achievable with your setup. |
| Chart not updating | Stream disabled / sensor unavailable | Check that STREAM ON succeeded (see log). Check sensor availability. |
| GUI freezes on connect | ESP32 sending boot logs | Wait for boot to complete (~2s). The GUI flushes stale data on connect. |
| CSV export is empty | Forgot to click Record | Click **Record** before starting the experiment, then **Stop** and **Export CSV**. |

---

## Development Status

- [x] I2C hardware abstraction layer
- [x] SLF3S flow sensor driver (auto-detect model, temperature, flags)
- [x] MCP4726 DAC driver (calibrated VDD=4.734V)
- [x] MP6 micropump driver (Enable + Clock PWM 25-300 Hz + DAC amplitude)
- [x] PID closed-loop controller (anti-windup, deviation detection, auto-stop)
- [x] Serial protocol (ASCII, 12 commands + 5 async events)
- [x] FreeRTOS dual-task architecture (serial_cmd_task + sensor_read_task)
- [x] Kconfig configuration system
- [x] Hardware hot-plug detection (firmware 5s re-probe + GUI 5s I2C scan)
- [x] Flow sensor calibration switching (Water / IPA)
- [x] Sensor flag detection (AIR_IN_LINE, HIGH_FLOW, edge-triggered events)
- [x] Host PC Python API (microfluidic_api.py, thread-safe)
- [x] Host PC PyQt5 GUI (Manual/PID modes, real-time charts, recording, alerts, hot-plug)
- [ ] Pressure sensor driver
- [ ] WiFi communication mode

---

## License

MIT License. See individual source file headers for details.

**Author:** Junjian Chi (jc2592@cam.ac.uk), Cambridge Sensor CDT
