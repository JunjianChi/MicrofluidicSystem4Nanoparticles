# Microfluidic Control System

> **Firmware V3.0.0** | **Host PC GUI V1.0.0** | ESP32 + FreeRTOS | Python PyQt5

An ESP32-based closed-loop microfluidic control system that mimics blood circulation for organ-on-chip and lab-on-chip applications. The system drives a Bartels MP6 piezoelectric micropump, measures real-time liquid flow with a Sensirion SLF3S sensor, and closes the loop with a PID controller -- all at 10 Hz. A Python GUI on the host PC provides manual pump control, PID mode, live charting, data recording with CSV export, and hardware hot-plug detection.

```
                          UART 115200 8N1
  ┌───────────────────┐ ◄──────────────────► ┌───────────────────────────────┐
  │   Host PC (GUI)   │                      │          ESP32 MCU            │
  │  main_gui.py      │                      │                               │
  │  microfluidic_api  │                      │  serial_cmd_task (pri 5)      │
  └───────────────────┘                      │  sensor_read_task (pri 6)     │
                                             │         │            │        │
                                             │    GPIO │ PWM   I2C  │        │
                                             └─────┼───┼────────────┼────────┘
                                                   │   │            │
                                             ┌─────┘   │   ┌───────┘
                                             ▼         ▼   ▼
                                          ┌────────┐ ┌──────────┐
                                          │MCP4726 │ │  SLF3S   │
                                          │DAC 0x61│ │Flow 0x08 │
                                          └────────┘ └──────────┘
                                            MP6 Pump
                                         (Enable+Clock)
```

---

## Table of Contents

1. [System Components](#1-system-components)
2. [Key Documentation Links](#2-key-documentation-links)
3. [Project Structure](#3-project-structure)
4. [Wiring Diagram](#4-wiring-diagram)
5. [Experiment Pipeline](#5-experiment-pipeline)
6. [Building the GUI Executable](#6-building-the-gui-executable)
7. [Serial Protocol Summary](#7-serial-protocol-summary)
8. [Software Architecture](#8-software-architecture)
9. [Safety and Best Practices](#9-safety-and-best-practices)
10. [Troubleshooting](#10-troubleshooting)

---

## 1. System Components

### 1.1 Bartels MP6 Micropump

| Parameter | Value |
|-----------|-------|
| Type | Piezoelectric diaphragm micropump |
| Dimensions | 30 x 15 x 3.8 mm |
| Max flow rate | ~7 ml/min (water) |
| Drive voltage | 0-250 Vpp (generated by MP-Driver board) |
| Drive frequency | 0-300 Hz |
| Media compatibility | Water, IPA, non-aggressive liquids |

The MP6 is a MEMS micropump driven by a piezoelectric actuator. It requires a high-voltage AC signal generated by the Bartels MP-Driver board. The pump flow rate is controlled by varying the **amplitude** (drive voltage) and **frequency** of the AC signal.

### 1.2 Bartels MP-Driver Board

| Parameter | Value |
|-----------|-------|
| Function | Low-voltage to high-voltage AC conversion |
| Inputs | Enable (digital), Clock (PWM), Amplitude (analog 0-3.3V) |
| Output | High-voltage AC to MP6 piezo element |
| Amplitude input range | 0.35 V - 1.30 V (maps to ~80-250 Vpp) |

The MP-Driver board accepts three control signals from the ESP32:
- **Enable** (GPIO 14): HIGH = pump running, LOW = shutdown
- **Clock** (GPIO 27): PWM signal at 95% duty cycle, frequency 25-300 Hz
- **Amplitude** (MCP4726 DAC output): 0.35-1.30 V analog voltage

### 1.3 Sensirion SLF3S Flow Sensor

| Parameter | SLF3S-0600F | SLF3S-1300F |
|-----------|-------------|-------------|
| Flow range | +/-3250 ul/min | 0-40 ml/min |
| Scale factor | 10 | 500 |
| Interface | I2C (address 0x08) | I2C (address 0x08) |
| Features | Bidirectional, air-in-line detection, temperature output |
| Calibration | Water (0x08) or IPA (0x15) |

The SLF3S is a liquid flow sensor with an integrated thermopile. It reports flow rate, temperature, and signaling flags (air-in-line, high flow) over I2C at up to 10 Hz.

**Signaling flags:**
- Bit 0 (`AIR_IN_LINE`): Air bubble detected in the flow path
- Bit 1 (`HIGH_FLOW`): Flow rate exceeds sensor measurement range
- Bit 5 (`EXP_SMOOTHING`): Exponential smoothing active

### 1.4 MCP4726 DAC

| Parameter | Value |
|-----------|-------|
| Resolution | 12-bit (4096 steps) |
| Interface | I2C (address 0x61) |
| Reference voltage | VDD (calibrated at 4.734 V) |
| Output range | 0 - 4.734 V |
| Purpose | Controls MP-Driver amplitude input |

The DAC converts the digital amplitude setting (80-250) to an analog voltage (0.35-1.30 V) for the MP-Driver board.

**Amplitude mapping:**
```
amplitude 80  -> 0.35 V -> DAC code 287
amplitude 250 -> 1.30 V -> DAC code 1065

Formula: voltage = 0.35 + (amplitude - 80) * (1.30 - 0.35) / (250 - 80)
         DAC_code = voltage / 4.734 * 4096
```

### 1.5 ESP32 DevKit

| Parameter | Value |
|-----------|-------|
| Framework | ESP-IDF with FreeRTOS |
| I2C bus | GPIO 21 (SDA), GPIO 22 (SCL), 100 kHz |
| PWM output | GPIO 27 (MP-Driver clock) |
| Enable output | GPIO 14 (MP-Driver shutdown) |
| UART | UART0 (USB), 115200 baud, 8N1 |
| Configuration | `idf.py menuconfig` (Kconfig) |

### 1.6 Bartels mp-bt Bubble Trap

| Parameter | Value |
|-----------|-------|
| Type | Passive inline bubble trap |
| Purpose | Removes air bubbles from tubing before the flow sensor |
| Placement | Between MP6 pump outlet and flow sensor inlet |

---

## 2. Key Documentation Links

### Bartels Mikrotechnik

| Resource | Description |
|----------|-------------|
| [Bartels Support Center](https://bartels-mikrotechnik.de/support-center/) | Technical support, FAQs, downloads |
| [MP6 Micropump Datasheet](https://bartels-mikrotechnik.de/microcomponents/) | Micropump specifications and operating guidelines |
| [MP-Driver Datasheet](https://bartels-mikrotechnik.de/microcomponents/) | Electronic driver board specifications |
| [Bartels Software Manual](https://bartels-mikrotechnik.de/support-center/) | MP6 software integration guide |

### Sensirion

| Resource | Description |
|----------|-------------|
| [SLF3S Datasheet](https://sensirion.com/products/catalog/SLF3S-0600F/) | Flow sensor specifications and performance data |
| [SLF3S I2C Communication Guide](https://sensirion.com/media/documents/) | I2C command reference, CRC, calibration |
| [Operating Guidelines](https://sensirion.com/media/documents/) | Handling, media compatibility, warm-up requirements |

### Espressif / MCP4726

| Resource | Description |
|----------|-------------|
| [ESP-IDF Programming Guide](https://docs.espressif.com/projects/esp-idf/en/latest/) | ESP32 development framework documentation |
| [MCP4726 Datasheet (Microchip)](https://www.microchip.com/en-us/product/mcp4726) | 12-bit DAC specifications |

---

## 3. Project Structure

```
SensorCDT_Microfluidic_Project/
├── README.md                          # This file - system tutorial and guide
├── overview.md                        # System design overview (Chinese)
├── implement.md                       # Implementation notes (Chinese)
├── API.md                             # Serial protocol specification (English)
│
├── Firmware/                          # ESP32 firmware (ESP-IDF project)
│   ├── CMakeLists.txt                 # Top-level CMake build file
│   ├── sdkconfig                      # ESP-IDF build configuration
│   ├── README.md                      # Firmware-specific notes
│   │
│   └── main/                          # Firmware source code
│       ├── CMakeLists.txt             # Component CMake file
│       ├── Kconfig.projbuild          # Menuconfig definitions (sensors, pins, comm)
│       ├── main.c                     # FreeRTOS task creation, hardware init
│       ├── main.h                     # System state struct, global declarations
│       ├── serial_comm.c/.h           # UART command parsing, response/event sending
│       ├── mp6_driver.c/.h            # MP6 micropump driver (amplitude, frequency, enable)
│       ├── mcp4726_dac.c/.h           # MCP4726 DAC I2C driver (voltage output)
│       ├── MCP4726_DAC.md             # DAC component documentation
│       ├── SLF3S_flow_sensor.c/.h     # SLF3S flow sensor I2C driver
│       ├── pid_controller.c/.h        # PID controller (anti-windup, deviation detect)
│       ├── i2c_interface.c/.h         # I2C bus abstraction (init, probe, scan)
│       ├── sensor_config.c/.h         # Pin assignments, I2C addresses, sampling rates
│       └── sensor_config.h            # Compile-time config from Kconfig
│
└── HostPC/                            # Host PC software (Python)
    ├── README.md                      # GUI user guide (see HostPC/README.md)
    ├── requirements.txt               # Python dependencies (PyQt5, pyqtgraph, pyserial)
    ├── microfluidic_api.py            # Serial API wrapper (MicrofluidicController class)
    └── main_gui.py                    # PyQt5 GUI application
```

---

## 4. Wiring Diagram

### Electrical Connections

```
                        ESP32 DevKit
                     ┌────────────────┐
                     │                │
              SDA ───┤ GPIO 21        │
              SCL ───┤ GPIO 22        │
                     │                │    ┌──────────────────┐
           Enable ───┤ GPIO 14  ──────────►│ MP-Driver Board  │
           Clock  ───┤ GPIO 27  ──────────►│   (Enable, Clk)  │──── MP6 Pump
                     │                │    │   (Amplitude)     │
                     │          USB ──┼────│                   │
                     └────────────────┘    └───────┬──────────┘
                                                   │
                           I2C Bus (100 kHz)        │ Amplitude
                     ┌─────────┬───────────┐       │
                     │         │           │       │
                ┌────┴────┐ ┌──┴───┐  ┌────┴──────┴──┐
                │ SLF3S   │ │0x76  │  │   MCP4726     │
                │ Flow    │ │Press.│  │   DAC (0x61)  │
                │ (0x08)  │ │(TBD) │  │   Vout ───────┘
                └─────────┘ └──────┘  └───────────────┘

    NOTE: 4.7k pull-up resistors required on SDA and SCL lines.
```

### Fluidic Circuit

```
    ┌──────────┐     ┌──────────┐     ┌──────────────┐     ┌──────────┐     ┌──────────┐
    │          │     │  Bartels │     │   Bartels    │     │ Sensirion│     │Microfluid│
    │Reservoir ├────►│ MP6 Pump ├────►│ mp-bt Bubble ├────►│  SLF3S   ├────►│  Chip    │
    │          │     │          │     │    Trap      │     │Flow Sensor│    │          │
    └────▲─────┘     └──────────┘     └──────────────┘     └──────────┘     └────┬─────┘
         │                                                                       │
         └───────────────────────────────────────────────────────────────────────┘
                                    Return to reservoir

    Flow direction: Reservoir -> Pump -> Bubble Trap -> Flow Sensor -> Chip -> Reservoir
```

### Default Pin Assignment

| Function | GPIO | Notes |
|----------|------|-------|
| I2C SDA | 21 | External 4.7k pull-up to 3.3V |
| I2C SCL | 22 | External 4.7k pull-up to 3.3V |
| MP-Driver Enable | 14 | HIGH = pump running |
| MP-Driver Clock | 27 | PWM, 95% duty, 25-300 Hz |

All pins are configurable via `idf.py menuconfig` > "Custom Configuration" > "Pin Configuration".

---

## 5. Experiment Pipeline

This section walks through a complete experiment from hardware assembly to data collection.

### Step 1: Hardware Assembly

**Electrical wiring:**
1. Connect ESP32 GPIO 21 (SDA) and GPIO 22 (SCL) to the I2C bus with 4.7k pull-up resistors to 3.3V.
2. Connect MCP4726 DAC (0x61) and SLF3S flow sensor (0x08) to the I2C bus.
3. Connect GPIO 14 to MP-Driver Enable input.
4. Connect GPIO 27 to MP-Driver Clock input.
5. Connect MCP4726 analog output to MP-Driver Amplitude input.
6. Connect MP-Driver output to MP6 micropump.
7. Power the ESP32 via USB. Power the MP-Driver per its datasheet requirements.

**Fluidic tubing:**
1. Connect the reservoir outlet to the MP6 pump inlet.
2. Connect the MP6 pump outlet to the Bartels mp-bt bubble trap inlet.
3. Connect the bubble trap outlet to the SLF3S flow sensor inlet.
4. Connect the flow sensor outlet to the microfluidic chip inlet.
5. Connect the chip outlet back to the reservoir (closed loop).

### Step 2: Firmware Setup

**Prerequisites:** ESP-IDF v5.x installed and configured.

```bash
cd Firmware

# Configure the project (select sensor model, pins, communication method)
idf.py menuconfig
```

In `menuconfig`, navigate to **"Custom Configuration"**:

| Menu | Setting | Options |
|------|---------|---------|
| Sensor Configuration | Enable Flow Sensor | Yes (default) |
| Sensor Configuration | Flow Sensor Product Model | **SLF3S-0600F** (+/-3250 ul/min) or SLF3S-1300F (0-40 ml/min) |
| Sensor Configuration | Enable Pressure Sensor | Yes/No |
| Sensor Configuration | Enable Temperature Sensor | Yes/No |
| Pump Driver Type | Pump Driver | MP-Driver (default), Low MP-Driver, High MP-Driver |
| Communication Method | Communication | Serial (default) or WiFi |
| Pin Configuration | I2C SDA Pin | 21 (default) |
| Pin Configuration | I2C SCL Pin | 22 (default) |
| Pin Configuration | MP Driver Enable Pin | 14 (default) |
| Pin Configuration | MP Driver Clock Pin | 27 (default) |

```bash
# Build and flash
idf.py build
idf.py -p COMx flash monitor
```

The firmware will:
1. Initialize UART (always succeeds -- fatal only if this fails)
2. Initialize I2C bus
3. Scan I2C bus for devices
4. Probe and initialize detected hardware (non-fatal if devices are missing)
5. Create `serial_cmd_task` (priority 5) and `sensor_read_task` (priority 6)
6. Begin accepting commands immediately

### Step 3: Host PC Software Install

**Option A: Run from source (recommended for development)**

```bash
cd HostPC
pip install -r requirements.txt
python main_gui.py
```

Dependencies: `PyQt5>=5.15`, `pyqtgraph>=0.13`, `pyserial>=3.5`

**Option B: Run the standalone executable** (see [Section 6](#6-building-the-gui-executable))

### Step 4: First Connection

1. Plug the ESP32 into USB. Note the COM port (e.g., COM3 on Windows, /dev/ttyUSB0 on Linux).
2. Launch the GUI (`python main_gui.py`).
3. Select the COM port from the dropdown and click **Connect**.
4. The GUI will:
   - Open the serial port at 115200 baud
   - Flush stale boot data (300 ms delay)
   - Run an **I2C Scan** to detect hardware
   - Enable the data stream (`STREAM ON`)
5. Check the **Status Bar** for hardware detection:
   - **Driver: OK** -- MCP4726 DAC (0x61) detected (pump driver available)
   - **Flow Sensor: OK** -- SLF3S (0x08) detected
   - **Pressure: OK/N/A** -- Pressure sensor (0x76) status
6. If a device shows **N/A**, check wiring. The GUI re-scans every 5 seconds and will auto-detect when you plug in a device.

### Step 5: Priming and Bubble Removal (CRITICAL)

Priming removes air from the tubing and fills the fluidic circuit with liquid. **This step is essential** -- the MP6 pump must never run dry, and air bubbles corrupt flow readings.

1. Fill the reservoir with your working liquid (deionized water or IPA).
2. Set the calibration to match your liquid: **Tools > Calibration > Water** or **IPA**.
3. In **Manual Mode**, set:
   - **Amplitude: 250** (maximum drive voltage)
   - **Frequency: 300 Hz** (maximum drive frequency)
4. Click **PUMP ON**.
5. Run until:
   - Liquid flows visibly through all tubing
   - The bubble trap has captured visible air pockets
   - The flow rate reading on the chart stabilizes
   - No `AIR_IN_LINE` alerts appear (check the Alerts panel)
6. Reduce amplitude/frequency to your working range and continue.

**Tips:**
- Gently tap the tubing and bubble trap to dislodge stubborn bubbles.
- If `AIR_IN_LINE` alerts persist, there may be a leak in the tubing connections.
- The bubble trap passively removes air -- no user action required once liquid flows through it.

### Step 6: Manual Experiment

Once primed, run a manual (open-loop) experiment:

1. Select **Manual** mode in the Mode dropdown.
2. Adjust **Amplitude** (80-250) and **Frequency** (25-300 Hz) using the sliders.
   - Sliders update the firmware in real-time with 150 ms debounce.
3. Click **PUMP ON** to start. The GUI sends `AMP`, `FREQ`, then `PUMP ON` commands.
4. Observe the **Flow Rate** chart -- it updates at 10 Hz.
5. To record data, click **Record**. When finished, click **Stop** and then **Export CSV**.
6. Click **PUMP OFF** to stop the pump.

### Step 7: PID Closed-Loop Experiment

For precise flow control, use PID mode:

1. Select **PID** mode in the Mode dropdown.
2. Configure the PID parameters:
   - **Target**: desired flow rate in ul/min (e.g., 10.00)
   - **Duration**: experiment length in seconds (0 = run indefinitely)
   - **PID Gains**: Kp, Ki, Kd (defaults: 1.0, 0.1, 0.01)
3. Click **START PID**. A confirmation dialog appears.
4. Confirm to start. The firmware will:
   - Send `PID TUNE` to set gains
   - Send `PID START <target> <duration>` to begin closed-loop control
   - Auto-start the pump and begin adjusting amplitude every 100 ms
5. The **Flow Rate** chart shows a red dashed **target line** at your setpoint.
6. Watch the PID converge: the flow rate should approach and track the target.
7. The status bar shows **elapsed/duration** time.
8. PID stops automatically when the duration expires (`EVENT PID_DONE`), or click **STOP PID** to end early.
9. On completion, the pump stops and the system returns to MANUAL mode.

**PID details:**
- Output range: amplitude 80-250 (maps directly to `mp6_set_amplitude`)
- Anti-windup: integral clamped to +/-500
- Flow deviation alert: if flow deviates >20% from target for >10 seconds, `EVENT FLOW_ERR` is sent
- Frequency is fixed at its current value when PID starts; PID only adjusts amplitude

---

## 6. Building the GUI Executable

To create a standalone executable that doesn't require a Python installation:

```bash
cd HostPC
pip install pyinstaller
pyinstaller --onefile --windowed --name MicrofluidicGUI main_gui.py
```

The executable will be in `HostPC/dist/MicrofluidicGUI.exe`.

**Prerequisites for end users:**
- USB-to-serial driver for your ESP32 board:
  - **CP2102** (Silicon Labs): [driver download](https://www.silabs.com/developers/usb-to-uart-bridge-vcp-drivers)
  - **CH340** (WCH): [driver download](http://www.wch-ic.com/downloads/CH341SER_EXE.html)
- The driver must be installed before the GUI can detect the COM port.

**Running the executable:**
1. Double-click `MicrofluidicGUI.exe`.
2. Select the COM port and click Connect.
3. All features work identically to the Python source version.

---

## 7. Serial Protocol Summary

The ESP32 firmware communicates via UART0 at **115200 baud, 8N1, ASCII, newline-terminated**.

### PC -> ESP32 Commands

| Command | Format | Response | Notes |
|---------|--------|----------|-------|
| Pump ON | `PUMP ON` | `OK` | Manual mode only. `ERR PID_ACTIVE` if PID running. `ERR PUMP_UNAVAIL` if no pump HW. |
| Pump OFF | `PUMP OFF` | `OK` | Auto-stops PID if in PID mode. |
| Set amplitude | `AMP <80-250>` | `OK` | Manual mode only. |
| Set frequency | `FREQ <25-300>` | `OK` | Manual mode only. Value in Hz. |
| PID start | `PID START <target> <duration>` | `OK` | target: ul/min (>0). duration: seconds (0=infinite). Requires pump + sensor. |
| PID stop | `PID STOP` | `OK` | Stops PID, returns to MANUAL, pump stops. |
| PID target | `PID TARGET <value>` | `OK` | Update target while running. `ERR NOT_PID_MODE` if not in PID. |
| PID tune | `PID TUNE <Kp> <Ki> <Kd>` | `OK` | Set PID gains. Works in any mode. |
| Status | `STATUS` | `S <fields...>` | See STATUS response format below. |
| I2C scan | `SCAN` | `SCAN [addr...]` | Returns detected I2C addresses (hex). |
| Stream ON | `STREAM ON` | `OK` | Enable 10 Hz data stream. |
| Stream OFF | `STREAM OFF` | `OK` | Disable data stream. |
| Calibration | `CAL <WATER\|IPA>` | `OK` | Switch flow sensor calibration liquid. |

### ESP32 -> PC Async Events

| Message | Format | Trigger |
|---------|--------|---------|
| Data stream | `D <flow> <temperature>` | 10 Hz when stream is ON |
| PID done | `EVENT PID_DONE` | PID duration expired |
| Flow error | `EVENT FLOW_ERR <target> <actual>` | Sustained flow deviation (>20% for >10s) |
| Air in line | `EVENT AIR_IN_LINE` | Air bubble detected (edge-triggered) |
| High flow | `EVENT HIGH_FLOW` | Flow exceeds sensor range (edge-triggered) |

### STATUS Response Format

```
S <mode> <pump> <amp> <freq> <flow> <target> <elapsed> <duration> <pump_hw> <sensor_hw> <pressure_hw> <temp>
```

| Field | Type | Description |
|-------|------|-------------|
| mode | string | `MANUAL` or `PID` |
| pump | 0/1 | Pump state (0=OFF, 1=ON) |
| amp | int | Current amplitude (80-250) |
| freq | int | Current frequency (25-300 Hz) |
| flow | float | Current flow reading (ul/min) |
| target | float | PID target (0.00 in MANUAL) |
| elapsed | int | PID elapsed seconds |
| duration | int | PID set duration (0=infinite) |
| pump_hw | 0/1 | Pump driver detected |
| sensor_hw | 0/1 | Flow sensor detected |
| pressure_hw | 0/1 | Pressure sensor detected |
| temp | float | Current temperature (C) |

### Error Codes

| Code | Meaning |
|------|---------|
| `UNKNOWN_CMD` | Unrecognized command |
| `INVALID_ARG` | Argument out of range or wrong format |
| `PID_ACTIVE` | Command blocked during PID mode |
| `NOT_PID_MODE` | `PID TARGET` sent when not in PID mode |
| `PUMP_UNAVAIL` | Pump hardware (DAC at 0x61) not detected |
| `SENSOR_UNAVAIL` | Flow sensor (0x08) not detected |

For the full protocol specification, see [API.md](API.md).

---

## 8. Software Architecture

```
┌──────────────────────────────────────────────────────┐
│  Host PC: main_gui.py (PyQt5) + microfluidic_api.py │  GUI + API
├──────────────────────────────────────────────────────┤
│              UART Protocol (ASCII, \n)               │  Communication
├──────────────────────────────────────────────────────┤
│         Application Layer (main.c)                   │  FreeRTOS tasks,
│  serial_cmd_task (pri 5) | sensor_read_task (pri 6)  │  command dispatch
├──────────────────────────────────────────────────────┤
│  pid_controller        │  serial_comm                │  PID control,
│                        │                             │  protocol parsing
├──────────────────────────────────────────────────────┤
│  SLF3S_flow_sensor  │  mp6_driver  │  mcp4726_dac   │  Device drivers
├──────────────────────────────────────────────────────┤
│              i2c_interface                            │  I2C HAL
├──────────────────────────────────────────────────────┤
│          sensor_config (Kconfig)                     │  Pin & sensor config
├──────────────────────────────────────────────────────┤
│            ESP-IDF / FreeRTOS                        │  Platform
└──────────────────────────────────────────────────────┘
```

### FreeRTOS Tasks

**serial_cmd_task (priority 5)**
- Blocks on UART, waiting for commands from the host PC
- Parses each command and calls the appropriate handler
- Each handler acquires the state mutex (`STATE_LOCK`) before modifying shared state
- Rejects manual control commands during PID mode (`ERR PID_ACTIVE`)

**sensor_read_task (priority 6, higher priority)**
- Runs every 100 ms (`vTaskDelayUntil`) for consistent 10 Hz sampling
- Reads flow, temperature, and flags from the SLF3S sensor
- Edge-detects `AIR_IN_LINE` and `HIGH_FLOW` flags (only sends event on 0->1 transition)
- In PID mode: computes PID output and sets pump amplitude
- Checks PID flow deviation (>20% for >10s -> `FLOW_ERR` event)
- Checks PID duration expiry (auto-stop -> `PID_DONE` event)
- Sends data stream (`D <flow> <temp>`) if streaming is enabled
- Every 5 seconds: re-probes I2C bus for unavailable devices (hot-plug detection)

### Closed-Loop Control

```
Setpoint (ul/min) ──►(+)──► PID Controller ──► Pump Amplitude (80-250)
                      │ -                              │
                      │                                ▼
                      │                         Microfluidic Channel
                      │                                │
                      └──── SLF3S Flow Sensor ◄────────┘
                              (10 Hz sampling)
```

- PID output maps directly to `mp6_set_amplitude()` (range 80-250)
- Frequency is fixed when PID starts; only amplitude is adjusted
- Anti-windup: integral term clamped to +/-500
- Output clamped to PID_OUTPUT_MIN (80) - PID_OUTPUT_MAX (250)

### Host PC Software

**microfluidic_api.py** -- Thread-safe Python API wrapping the serial protocol:
- Background listener thread reads UART continuously
- Dispatches `D` lines to `on_data(flow, temperature)` callback
- Dispatches `EVENT` lines to corresponding callbacks (`on_pid_done`, `on_flow_err`, `on_air_in_line`, `on_high_flow`)
- Filters ESP-IDF log lines (regex: `[EWIDV] (\d+) ...`) and boot garbage
- Synchronous command/response with 2-second timeout

**main_gui.py** -- PyQt5 GUI application:
- `SignalBridge` class converts API callbacks (background thread) to Qt signals (GUI thread)
- Split layout: left panel (controls) + right panel (charts, status, log)
- `QStackedWidget` switches between Manual and PID control pages
- `pyqtgraph` for real-time 10 Hz chart updates
- Timers: chart refresh (100 ms), status poll (1s), connection check (2s), hardware scan (5s), slider debounce (150 ms)

For detailed GUI documentation, see [HostPC/README.md](HostPC/README.md).

---

## 9. Safety and Best Practices

### Pump Safety (Bartels MP6)

- **Never run the pump dry.** Always prime the system with liquid before starting the pump. Running dry can damage the piezo element.
- **Prime before every experiment.** See [Step 5: Priming and Bubble Removal](#step-5-priming-and-bubble-removal-critical).
- **Maximum amplitude is 250, maximum frequency is 300 Hz.** These are hard limits enforced in firmware.
- **Use compatible liquids only.** Water and IPA are tested. Avoid aggressive solvents that could damage the pump diaphragm.

### Flow Sensor Safety (Sensirion SLF3S)

- **Warm-up time.** Allow the sensor to stabilize for ~30 seconds after power-on before trusting readings.
- **Avoid sustained air slugs.** Large air pockets can cause erratic readings and trigger `AIR_IN_LINE`. Use the bubble trap.
- **Match calibration to your liquid.** Use `CAL WATER` for water-based media or `CAL IPA` for isopropanol. Mismatched calibration produces inaccurate readings.
- **Do not exceed sensor range.** The SLF3S-0600F has a range of +/-3250 ul/min. Exceeding this triggers `HIGH_FLOW`.

### Electrical Safety

- **4.7k pull-up resistors** on I2C SDA and SCL lines (to 3.3V). Without pull-ups, I2C communication will be unreliable.
- **Verify I2C addresses** with the SCAN command before running experiments.
- **Check DAC reference voltage.** The MCP4726 VDD is calibrated at 4.734V. If your power supply differs, the amplitude mapping may need adjustment in firmware (`MCP4726_VDD` in `mcp4726_dac.h`).

### PID Tuning Tips

- Start with conservative gains: Kp=1.0, Ki=0.1, Kd=0.01.
- Increase Kp for faster response, but watch for oscillation.
- Increase Ki to eliminate steady-state error, but reduce it if you see overshoot.
- Kd helps dampen oscillation but amplifies noise -- use sparingly.
- Monitor the flow chart during tuning to observe convergence behavior.

---

## 10. Troubleshooting

| Symptom | Possible Cause | Solution |
|---------|---------------|----------|
| GUI cannot find COM port | USB driver not installed | Install CP2102 or CH340 driver. Click **Refresh** in the GUI. |
| "Connection Error" on connect | Wrong COM port / port in use | Close other serial monitors. Verify the correct port in Device Manager. |
| I2C scan returns no devices | Wiring error / no pull-ups | Check SDA/SCL connections. Add 4.7k pull-up resistors to 3.3V. |
| Driver: N/A (pump not detected) | MCP4726 DAC not on I2C bus | Check DAC wiring to SDA/SCL. Verify power to DAC. Run I2C Scan. |
| Flow Sensor: N/A | SLF3S not on I2C bus | Check sensor wiring. Ensure sensor is powered. Run I2C Scan. |
| Flow reading is 0.00 | Pump not running / air in line | Start the pump. Prime the system. Check for `AIR_IN_LINE` alerts. |
| Flow reading is noisy/unstable | Air bubbles in tubing | Run priming at max amplitude/frequency. Tap tubing and bubble trap. |
| `AIR_IN_LINE` alert won't clear | Persistent air in flow path | Re-prime the system. Check for leaks in tubing connections. |
| `ERR PID_ACTIVE` | Manual command sent during PID | Stop PID first (`PID STOP` or click STOP PID), then use manual controls. |
| `ERR PUMP_UNAVAIL` / `ERR SENSOR_UNAVAIL` | Hardware not detected | Check I2C wiring. Hot-plug detection will auto-detect when reconnected. |
| PID oscillates / doesn't converge | PID gains too aggressive | Reduce Kp. Reduce Ki. Start with defaults (1.0, 0.1, 0.01). |
| `EVENT FLOW_ERR` during PID | Flow deviates >20% for >10s | Check for bubbles, leaks, or blockages. Verify target is achievable with your setup. |
| Chart not updating | Stream disabled / sensor unavailable | Check that STREAM ON succeeded (see log). Check sensor availability. |
| GUI freezes on connect | ESP32 sending boot logs | Wait for boot to complete (~2s). The GUI flushes stale data on connect. |
| CSV export is empty | Forgot to click Record | Click **Record** before starting the experiment, then **Stop** and **Export CSV**. |

---

## Development Status

- [x] I2C hardware abstraction layer
- [x] SLF3S flow sensor driver (auto-detect model, temperature, flags)
- [x] MCP4726 DAC driver (calibrated VDD=4.734V)
- [x] MP6 micropump driver (Enable + Clock PWM 25-300 Hz + DAC amplitude)
- [x] PID closed-loop controller (anti-windup, deviation detection, auto-stop)
- [x] Serial protocol (ASCII, 12 commands + 5 async events)
- [x] FreeRTOS dual-task architecture (serial_cmd_task + sensor_read_task)
- [x] Kconfig configuration system
- [x] Hardware hot-plug detection (firmware 5s re-probe + GUI 5s I2C scan)
- [x] Flow sensor calibration switching (Water / IPA)
- [x] Sensor flag detection (AIR_IN_LINE, HIGH_FLOW, edge-triggered events)
- [x] Host PC Python API (microfluidic_api.py, thread-safe)
- [x] Host PC PyQt5 GUI (Manual/PID modes, real-time charts, recording, alerts, hot-plug)
- [ ] Pressure sensor driver
- [ ] WiFi communication mode

---

## License

MIT License. See individual source file headers for details.

**Author:** Junjian Chi (jc2592@cam.ac.uk), Cambridge Sensor CDT
